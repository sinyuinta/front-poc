<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²å®Œäº†</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        text-align: center;
        padding-top: 100px;
        background: #f4f7fb;
      }
      h1 {
        color: #2b7b2b;
      }
      p {
        color: #333;
        font-size: 1.1rem;
      }
      a {
        color: #0078ff;
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <h1>âœ… ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸï¼</h1>
    <p>ã“ã‚Œã§å…¨æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã™yoã€‚<br />æ€è€ƒã‚¢ã‚¹ãƒ¬ãƒãƒƒã‚¯ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ï¼</p>

    <p style="margin-top: 30px; color:#666;">è‡ªå‹•ã§åæ˜ ä¸­...</p>

    <a href="/">â† ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹</a>

    <!-- ğŸ”¥ ãƒ—ãƒ©ãƒ³è‡ªå‹•æ›´æ–°å‡¦ç† -->
    <script>
      (async () => {
        try {
          // ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ä¿å­˜ã•ã‚ŒãŸ Google ãƒ¦ãƒ¼ã‚¶ãƒ¼ tokenï¼ˆJWTï¼‰
          const token = localStorage.getItem("shikoUserToken");
          if (!token) {
            console.warn("tokenãªã— â†’ ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹");
            location.href = "/";
            return;
          }

          // â˜…ä¿®æ­£ï¼šä½™è¨ˆãªã€Œuser_ã€ã¯ä»˜ã‘ãªã„ï¼ˆtokenã«å«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
          const userKey = encodeURIComponent(token.split("?")[0]);

          // â˜… import.meta ã¯é€šå¸¸ HTML ã§ã¯ä½¿ãˆãªã„ãŸã‚ã€base URL ã‚’å›ºå®š
          const base = "https://ms-engine-test.sinnosukeyamane.workers.dev";

          const url = `${base}/persona/getPlan?user=${userKey}`;
          console.log("Fetch:", url);

          const res = await fetch(url);
          const data = await res.json();

          console.log("ğŸ”„ getPlan:", data);

          // KV ã® plan ã‚’ localStorage ã«ä¿å­˜ï¼ˆApp.jsx ãŒã“ã‚Œã‚’èª­ã‚€ï¼‰
          if (data.plan) {
            localStorage.setItem("shikoPlan", data.plan);
          }

          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒˆãƒƒãƒ—ã¸æˆ»ã™
          setTimeout(() => {
            location.href = "/";
          }, 15000);

        } catch (err) {
          console.error("plan fetch error:", err);
          location.href = "/";
        }
      })();
    </script>
  </body>
</html>
